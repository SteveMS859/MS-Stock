<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Stock - Société</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .hidden { display: none; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: center; }
        button { padding: 5px 10px; margin: 5px; }
        input { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="loginPage">
        <h2>Connexion</h2>
        <label>Identifiant: </label><input type="text" id="username"><br>
        <label>Mot de passe: </label><input type="password" id="password"><br>
        <button onclick="login()">Se connecter</button>
        <p id="error" style="color: red;"></p>
    </div>

    <!-- Page utilisateur (gestion stock) -->
    <div id="userPage" class="hidden">
        <h2>Stock du bâtiment <span id="batimentName"></span></h2>
        <table>
            <thead>
                <tr><th>Objet</th><th>Quantité</th><th>Action</th></tr>
            </thead>
            <tbody id="stockTable"></tbody>
        </table>
        <button onclick="logout()">Déconnexion</button>
    </div>

    <!-- Page admin (vue globale + gestion identifiants) -->
    <div id="adminPage" class="hidden">
        <h2>Vue globale des stocks</h2>
        <table>
            <thead id="adminTableHead"></thead>
            <tbody id="adminTableBody"></tbody>
        </table>
        <h3>Gérer les identifiants</h3>
        <table id="credentialsTable">
            <thead>
                <tr><th>Bâtiment</th><th>Identifiant</th><th>Mot de passe</th><th>Action</th></tr>
            </thead>
            <tbody id="credentialsTableBody"></tbody>
        </table>
        <button onclick="logout()">Déconnexion</button>
    </div>

    <script>
        // Données initiales
        let buildings = {
            "Bat1": { password: "MDP_Bat1", stock: { "Stylo": 50, "Cahier": 20, "Clavier": 10 } },
            "Bat2": { password: "MDP_Bat2", stock: { "Stylo": 30, "Cahier": 15, "Clavier": 5 } },
            "Bat3": { password: "MDP_Bat3", stock: { "Stylo": 40, "Cahier": 10, "Clavier": 8 } },
            "Bat4": { password: "MDP_Bat4", stock: { "Stylo": 20, "Cahier": 25, "Clavier": 15 } },
            "Bat5": { password: "MDP_Bat5", stock: { "Stylo": 60, "Cahier": 30, "Clavier": 12 } },
            "Bat6": { password: "MDP_Bat6", stock: { "Stylo": 25, "Cahier": 5, "Clavier": 20 } }
        };
        const adminCredentials = { username: "Admin", password: "MDP_Admin" };

        let currentUser = null;

        // Charger les données depuis localStorage ou initialiser
        if (localStorage.getItem("stocks")) {
            buildings = JSON.parse(localStorage.getItem("stocks"));
        } else {
            localStorage.setItem("stocks", JSON.stringify(buildings));
        }

        function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const error = document.getElementById("error");

            if (username === adminCredentials.username && password === adminCredentials.password) {
                currentUser = "Admin";
                showAdminPage();
            } else {
                let found = false;
                for (let bat in buildings) {
                    if (username === bat && password === buildings[bat].password) {
                        currentUser = bat;
                        showUserPage(bat);
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    error.textContent = "Identifiants incorrects";
                }
            }
        }

        function showUserPage(batiment) {
            document.getElementById("loginPage").classList.add("hidden");
            document.getElementById("userPage").classList.remove("hidden");
            document.getElementById("batimentName").textContent = batiment;

            const stock = buildings[batiment].stock;
            const tableBody = document.getElementById("stockTable");
            tableBody.innerHTML = "";

            for (let item in stock) {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item}</td>
                    <td>${stock[item]}</td>
                    <td>
                        <input type="number" id="qty_${item}" min="0" placeholder="Quantité">
                        <button onclick="updateStock('${batiment}', '${item}', 'add')">Ajouter</button>
                        <button onclick="updateStock('${batiment}', '${item}', 'remove')">Retirer</button>
                    </td>`;
                tableBody.appendChild(row);
            }
        }

        function updateStock(batiment, item, action) {
            const qty = parseInt(document.getElementById(`qty_${item}`).value) || 0;
            if (action === "add") {
                buildings[batiment].stock[item] += qty;
            } else if (action === "remove" && buildings[batiment].stock[item] >= qty) {
                buildings[batiment].stock[item] -= qty;
            }
            localStorage.setItem("stocks", JSON.stringify(buildings));
            showUserPage(batiment);
        }

        function showAdminPage() {
            document.getElementById("loginPage").classList.add("hidden");
            document.getElementById("adminPage").classList.remove("hidden");

            // Afficher les stocks
            const items = ["Stylo", "Cahier", "Clavier"];
            const head = document.getElementById("adminTableHead");
            const body = document.getElementById("adminTableBody");
            head.innerHTML = "<tr><th>Bâtiment</th>" + items.map(i => `<th>${i}</th>`).join("") + "</tr>";
            body.innerHTML = "";
            for (let bat in buildings) {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${bat}</td>` + items.map(i => `<td>${buildings[bat].stock[i]}</td>`).join("");
                body.appendChild(row);
            }

            // Afficher la gestion des identifiants
            const credBody = document.getElementById("credentialsTableBody");
            credBody.innerHTML = "";
            for (let bat in buildings) {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${bat}</td>
                    <td><input type="text" id="id_${bat}" value="${bat}"></td>
                    <td><input type="text" id="pass_${bat}" value="${buildings[bat].password}"></td>
                    <td><button onclick="updateCredentials('${bat}')">Mettre à jour</button></td>`;
                credBody.appendChild(row);
            }
        }

        function updateCredentials(oldBatiment) {
            const newId = document.getElementById(`id_${oldBatiment}`).value;
            const newPass = document.getElementById(`pass_${oldBatiment}`).value;

            if (newId !== oldBatiment) {
                // Créer une nouvelle entrée et supprimer l’ancienne
                buildings[newId] = { password: newPass, stock: buildings[oldBatiment].stock };
                delete buildings[oldBatiment];
            } else {
                // Mettre à jour uniquement le mot de passe
                buildings[oldBatiment].password = newPass;
            }
            localStorage.setItem("stocks", JSON.stringify(buildings));
            showAdminPage(); // Rafraîchir la page
        }

        function logout() {
            currentUser = null;
            document.getElementById("loginPage").classList.remove("hidden");
            document.getElementById("userPage").classList.add("hidden");
            document.getElementById("adminPage").classList.add("hidden");
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            document.getElementById("error").textContent = "";
        }
    </script>
</body>
</html>
